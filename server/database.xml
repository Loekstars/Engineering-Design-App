<?xml version="1.0" encoding="utf-8"?>
<!--
- phpMyAdmin XML Dump
- version 5.2.0
- https://www.phpmyadmin.net
-
- Host: 127.0.0.1
- Generation Time: Oct 17, 2022 at 08:42 PM
- Server version: 10.4.25-MariaDB
- PHP Version: 8.1.10
-->

<pma_xml_export version="1.0" xmlns:pma="https://www.phpmyadmin.net/some_doc_url/">
    <!--
    - Structure schemas
    -->
    <pma:structure_schemas>
        <pma:database name="app database" collation="utf8mb4_general_ci" charset="utf8mb4">
            <pma:table name="lights">
                CREATE TABLE `lights` (
                  `light_id` int(11) NOT NULL AUTO_INCREMENT,
                  `luminance` int(11) NOT NULL,
                  PRIMARY KEY (`light_id`)
                ) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8mb4;
            </pma:table>
            <pma:table name="raw_data">
                CREATE TABLE `raw_data` (
                  `timestamp` datetime NOT NULL DEFAULT current_timestamp(),
                  `sensor_id` int(11) NOT NULL,
                  `data` int(11) NOT NULL,
                  PRIMARY KEY (`sensor_id`,`timestamp`)
                ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
            </pma:table>
            <pma:trigger name="refine_sql">
                CREATE TRIGGER `refine_sql` AFTER INSERT ON `raw_data`
                 FOR EACH ROW INSERT INTO refined_data (refined_data.timestamp,refined_data.sensor_id,refined_data.data)
                	SELECT MAX(f.t),NEW.sensor_id,AVG(f.d)
                	FROM (
                        SELECT raw_data.timestamp AS t, raw_data.sensor_id AS s, raw_data.data AS d
                    	FROM raw_data
                    	WHERE raw_data.sensor_id = NEW.sensor_id AND TIMESTAMPDIFF(MINUTE,raw_data.timestamp,CURRENT_TIMESTAMP)&lt;10
                    	ORDER BY raw_data.timestamp
                    	DESC
                    	LIMIT 5
                    ) f
            </pma:trigger>
            <pma:table name="refined_data">
                CREATE TABLE `refined_data` (
                  `timestamp` datetime NOT NULL DEFAULT current_timestamp(),
                  `sensor_id` int(11) NOT NULL,
                  `data` int(11) NOT NULL,
                  PRIMARY KEY (`timestamp`,`sensor_id`)
                ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
            </pma:table>
        </pma:database>
    </pma:structure_schemas>

    <!--
    - Database: 'app database'
    -->
    <database name="app database">
        <!-- Table lights -->
        <table name="lights">
            <column name="light_id">1</column>
            <column name="luminance">70</column>
        </table>
        <!-- Table raw_data -->
        <table name="raw_data">
            <column name="timestamp">2022-10-17 19:54:59</column>
            <column name="sensor_id">1</column>
            <column name="data">80</column>
        </table>
        <table name="raw_data">
            <column name="timestamp">2022-10-17 20:29:28</column>
            <column name="sensor_id">2</column>
            <column name="data">3</column>
        </table>
        <table name="raw_data">
            <column name="timestamp">2022-10-17 20:31:33</column>
            <column name="sensor_id">2</column>
            <column name="data">7</column>
        </table>
        <table name="raw_data">
            <column name="timestamp">2022-10-17 20:37:33</column>
            <column name="sensor_id">2</column>
            <column name="data">13</column>
        </table>
        <table name="raw_data">
            <column name="timestamp">2022-10-17 20:38:00</column>
            <column name="sensor_id">2</column>
            <column name="data">16</column>
        </table>
        <table name="raw_data">
            <column name="timestamp">2022-10-17 20:00:27</column>
            <column name="sensor_id">4</column>
            <column name="data">81</column>
        </table>
        <table name="raw_data">
            <column name="timestamp">2022-10-17 20:00:12</column>
            <column name="sensor_id">5</column>
            <column name="data">98</column>
        </table>
        <table name="raw_data">
            <column name="timestamp">2022-10-17 20:00:21</column>
            <column name="sensor_id">5</column>
            <column name="data">18</column>
        </table>
        <!-- Table refined_data -->
        <table name="refined_data">
            <column name="timestamp">2022-10-17 19:31:50</column>
            <column name="sensor_id">1</column>
            <column name="data">1232</column>
        </table>
        <table name="refined_data">
            <column name="timestamp">2022-10-17 20:29:28</column>
            <column name="sensor_id">2</column>
            <column name="data">3</column>
        </table>
        <table name="refined_data">
            <column name="timestamp">2022-10-17 20:31:33</column>
            <column name="sensor_id">2</column>
            <column name="data">5</column>
        </table>
        <table name="refined_data">
            <column name="timestamp">2022-10-17 20:37:33</column>
            <column name="sensor_id">2</column>
            <column name="data">8</column>
        </table>
        <table name="refined_data">
            <column name="timestamp">2022-10-17 20:38:00</column>
            <column name="sensor_id">2</column>
            <column name="data">10</column>
        </table>
    </database>
</pma_xml_export>